trigger:
  batch: true
  branches:
    include:
    - main
  paths:
    exclude:
      - README.md
      - pipelines

stages:
  - stage: TerraformInit
    displayName: Terraform init and validate
    pool:
      vmImage: ubuntu-latest
    jobs:
    # Install latest terraform on agent and run init
    - job: TerraformInstallSetUp 
      displayName: Install terraform latest and terrafrom init
      steps:
        - task: TerraformInstaller@1
          displayName: "Latest Version of terraform installation"
          inputs:
            terraformVersion: 'latest'
        - task: TerraformTaskV4@4
          displayName: terraform init
          inputs:
            provider: 'azurerm'
            command: 'init'
            backendServiceArm: 'BeStrong'
            backendAzureRmResourceGroupName: 'tf-tfstate-ResourceGroup'
            backendAzureRmStorageAccountName: 'tfstatestac3e7d7b3d'
            backendAzureRmContainerName: 'tf-tfstate-for-production'
            backendAzureRmKey: 'prod.tfstate'
        - task: TerraformTaskV4@4
          displayName: terraform validate
          inputs:
            provider: 'azurerm'
            command: 'validate'
        - task: TerraformTaskV4@4
          displayName: terraform plan
          inputs:
            provider: 'azurerm'
            command: 'plan'
